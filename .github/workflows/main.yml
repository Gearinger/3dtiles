# Windows 构建并发布 Release Workflow（支持手动触发）
name: Build Windows EXE and Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g. v0.1.0). If empty, a fallback tag manual-<run_id> will be used.'
        required: false
      release_name:
        description: 'Release title (optional).'
        required: false
      create_release:
        description: 'Whether to create GitHub Release and upload asset (true/false).'
        required: false
        default: 'true'

jobs:
  build-windows-release:
    name: Build on Windows and publish Release
    runs-on: windows-latest
    env:
      # 如果仓库里有 vcpkg 子目录，这里设定 VCPKG_ROOT 指向工作区下的 vcpkg
      VCPKG_ROOT: ${{ github.workspace }}\vcpkg

    steps:
      - name: Checkout repository (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Prepare vcpkg (if present)
        shell: pwsh
        run: |
          if (Test-Path -Path "$env:GITHUB_WORKSPACE\vcpkg") {
            Push-Location "$env:GITHUB_WORKSPACE\vcpkg"
            Write-Host "Bootstrapping vcpkg..."
            .\bootstrap-vcpkg.bat
            Pop-Location
          } else {
            Write-Host "vcpkg not found, skipping vcpkg bootstrap."
          }

      - name: Setup Rust (stable)
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Verify rust & cargo
        shell: pwsh
        run: |
          rustc --version
          cargo --version

      - name: Build (cargo release)
        shell: pwsh
        run: |
          # 确保在仓库根执行构建（若需要，请在 cargo build 前设置任何额外 env）
          cargo build --release -v

      - name: Collect EXE artifacts and zip
        id: pack
        shell: pwsh
        run: |
          $outDir = Join-Path $env:GITHUB_WORKSPACE 'release_artifacts'
          if (-Not (Test-Path $outDir)) { New-Item -ItemType Directory -Path $outDir | Out-Null }

          Write-Host "Searching for .
